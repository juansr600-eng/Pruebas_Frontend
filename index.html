<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Sensores</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-3.1.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .sensor-table {
            margin-bottom: 30px;
        }
        .sensor-table th {
            background-color: #337ab7;
            color: white;
            text-align: center;
        }
        .sensor-table td {
            text-align: center;
            vertical-align: middle;
        }
        .sensor-value {
            font-weight: bold;
            font-size: 16px;
        }
        .chart-controls {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .chart-container {
            margin-top: 20px;
            min-height: 400px;
        }
        .pagination-controls {
            margin: 15px 0;
            text-align: center;
        }
        .btn-group {
            margin: 5px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .sensor-table {
                font-size: 12px;
            }
            .chart-controls {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Monitor de Sensores en Tiempo Real</h1>
        
        <!-- Tabla de sensores -->
        <div class="sensor-table">
            <h3>Estado Actual de Sensores</h3>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Sensor</th>
                        <th>칔ltimo Valor</th>
                        <th>Fecha/Hora</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="sensorsTableBody">
                    <!-- Se llena din치micamente -->
                </tbody>
            </table>
        </div>

        <!-- Controles de gr치fica -->
        <div class="chart-controls">
            <h3>An치lisis Hist칩rico</h3>
            <div class="row">
                <div class="col-md-4">
                    <label for="sensorSelect">Seleccionar Sensor:</label>
                    <select id="sensorSelect" class="form-control">
                        <option value="">Seleccione un sensor...</option>
                        <option value="sensor1">Sensor 1</option>
                        <option value="sensor2">Sensor 2</option>
                        <option value="sensor3">Sensor 3</option>
                        <option value="sensor4">Sensor 4</option>
                        <option value="sensor5">Sensor 5</option>
                        <option value="sensor6">Sensor 6</option>
                        <option value="sensor7">Sensor 7</option>
                        <option value="sensor8">Sensor 8</option>
                        <option value="sensor9">Sensor 9</option>
                        <option value="sensor10">Sensor 10</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary form-control" onclick="cargarDatosSensor()">
                        游늵 Cargar Datos del Sensor
                    </button>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button class="btn btn-success form-control" onclick="cargarTodosLosSensores()">
                        游늳 Vista General (Todos)
                    </button>
                </div>
            </div>
        </div>

        <!-- Controles de paginaci칩n -->
        <div class="pagination-controls" id="paginacionControles" style="display: none;">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="paginarPor('dias')">游늰 Por D칤as</button>
                <button class="btn btn-sm btn-outline-primary" onclick="paginarPor('semanas')">游늵 Por Semanas</button>
                <button class="btn btn-sm btn-outline-primary" onclick="paginarPor('meses')">游늳 Por Meses</button>
                <button class="btn btn-sm btn-outline-primary" onclick="paginarPor('a침os')">游늴 Por A침os</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn btn-sm btn-secondary" onclick="anteriorPagina()">&lt;</button>
                <span id="paginaInfo" style="margin: 0 10px;">P치gina 1 de 1</span>
                <button class="btn btn-sm btn-secondary" onclick="siguientePagina()">&gt;</button>
            </div>
        </div>

        <!-- Contenedor de gr치fica -->
        <div class="chart-container">
            <div id="myPlot" style="width: 100%; height: 500px;"></div>
        </div>
    </div>

    <script>
        // Variables globales
        const SERVER_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3003' 
            : 'https://pruebas-backend-pfqz.onrender.com';
        let datosConsultados = [];
        let paginaActual = 0;
        let tipoPaginacion = 'dias';
        let datosPaginados = [];
        let sensorSeleccionado = '';

        // Funci칩n para actualizar tabla de sensores
        async function actualizarTablaSensores() {
            try {
                const response = await fetch(`${SERVER_URL}/api/sensores-info`);
                const info = await response.json();
                
                if (!info.lastRecord) {
                    $('#sensorsTableBody').html('<tr><td colspan="4">No hay datos disponibles</td></tr>');
                    return;
                }

                const lastRecord = info.lastRecord;
                const tbody = $('#sensorsTableBody');
                tbody.empty();

                // Crear filas para cada sensor (sensor1 a sensor10)
                for (let i = 1; i <= 10; i++) {
                    const sensorKey = `sensor${i}`;
                    const valor = lastRecord.sensores && lastRecord.sensores[sensorKey] ? lastRecord.sensores[sensorKey].valor : undefined;
                    const fecha = lastRecord.fechaHora ? new Date(lastRecord.fechaHora).toLocaleString('es-ES') : 'N/A';
                    const estado = valor !== undefined ? 'Activo' : 'Sin datos';
                    const valorMostrar = valor !== undefined ? `${valor} mm` : 'N/A';

                    const row = `
                        <tr>
                            <td><strong>Sensor ${i}</strong></td>
                            <td class="sensor-value">${valorMostrar}</td>
                            <td>${fecha}</td>
                            <td>
                                <span class="label ${estado === 'Activo' ? 'label-success' : 'label-default'}">
                                    ${estado}
                                </span>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                }

                console.log('Tabla de sensores actualizada');
            } catch (error) {
                console.error('Error actualizando tabla:', error);
                $('#sensorsTableBody').html('<tr><td colspan="4"><i class="glyphicon glyphicon-refresh"></i> Obteniendo datos...</td></tr>');
            }
        }

        // Funci칩n para cargar datos de un sensor espec칤fico
        async function cargarDatosSensor() {
            const sensor = $('#sensorSelect').val();
            if (!sensor) {
                alert('Por favor selecciona un sensor');
                return;
            }

            sensorSeleccionado = sensor;
            $('#myPlot').html('<div style="text-align:center;padding:50px;">Cargando datos del ' + sensor + '...</div>');

            try {
                const allData = await loadAllSensorData();
                const sensorData = allData
                    .filter(record => record.sensores && record.sensores[sensor] && record.sensores[sensor].valor !== undefined)
                    .map(record => ({
                        x: record.fechaHora,
                        y: record.sensores[sensor].valor
                    }));

                if (sensorData.length === 0) {
                    $('#myPlot').html('<div style="text-align:center;padding:50px;">No hay datos para este sensor</div>');
                    return;
                }

                // Crear gr치fica
                const trace = {
                    x: sensorData.map(d => d.x),
                    y: sensorData.map(d => d.y),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: sensor.toUpperCase(),
                    line: { color: '#337ab7' }
                };

                const layout = {
                    title: `Datos Hist칩ricos - ${sensor.toUpperCase()}`,
                    xaxis: { title: 'Fecha/Hora' },
                    yaxis: { title: 'Valor (mm)' },
                    responsive: true
                };

                Plotly.newPlot('myPlot', [trace], layout);
                datosConsultados = sensorData;
                $('#paginacionControles').show();

            } catch (error) {
                console.error('Error cargando datos del sensor:', error);
                $('#myPlot').html('<div style="text-align:center;padding:50px;">Error cargando datos</div>');
            }
        }

        // Funci칩n para cargar todos los sensores
        async function cargarTodosLosSensores() {
            $('#myPlot').html('<div style="text-align:center;padding:50px;">Cargando datos de todos los sensores...</div>');

            try {
                const allData = await loadAllSensorData();
                const traces = [];
                const colors = ['#337ab7', '#5cb85c', '#f0ad4e', '#d9534f', '#5bc0de', '#292b2c', '#f7941d', '#6f42c1', '#e83e8c', '#20c997'];

                for (let i = 1; i <= 10; i++) {
                    const sensor = `sensor${i}`;
                    const sensorData = allData
                        .filter(record => record.sensores && record.sensores[sensor] && record.sensores[sensor].valor !== undefined)
                        .map(record => ({
                            x: record.fechaHora,
                            y: record.sensores[sensor].valor
                        }));

                    if (sensorData.length > 0) {
                        traces.push({
                            x: sensorData.map(d => d.x),
                            y: sensorData.map(d => d.y),
                            type: 'scatter',
                            mode: 'lines',
                            name: `Sensor ${i}`,
                            line: { color: colors[i-1] }
                        });
                    }
                }

                if (traces.length === 0) {
                    $('#myPlot').html('<div style="text-align:center;padding:50px;">No hay datos disponibles</div>');
                    return;
                }

                const layout = {
                    title: 'Vista General - Todos los Sensores',
                    xaxis: { title: 'Fecha/Hora' },
                    yaxis: { title: 'Valor (mm)' },
                    responsive: true
                };

                Plotly.newPlot('myPlot', traces, layout);
                $('#paginacionControles').hide();

            } catch (error) {
                console.error('Error cargando todos los sensores:', error);
                $('#myPlot').html('<div style="text-align:center;padding:50px;">Error cargando datos</div>');
            }
        }

        // Funci칩n para cargar todos los datos del sensor
        async function loadAllSensorData() {
            try {
                const response = await fetch(`${SERVER_URL}/api/sensores-data?limit=2000&offset=0`);
                return await response.json();
            } catch (error) {
                console.error('Error cargando datos:', error);
                return [];
            }
        }

        // Funciones de paginaci칩n (placeholder)
        function paginarPor(tipo) {
            tipoPaginacion = tipo;
            console.log('Paginando por:', tipo);
        }

        function anteriorPagina() {
            if (paginaActual > 0) {
                paginaActual--;
                console.log('P치gina anterior:', paginaActual);
            }
        }

        function siguientePagina() {
            paginaActual++;
            console.log('P치gina siguiente:', paginaActual);
        }

        // Inicializaci칩n
        $(document).ready(function() {
            console.log('Aplicaci칩n iniciada');
            actualizarTablaSensores();
            
            // Actualizar tabla cada 30 segundos
            setInterval(actualizarTablaSensores, 30000);
        });
    </script>
</body>
</html>