<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Sensores</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-3.1.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .sensor-table {
            margin-bottom: 30px;
        }
        .sensor-table th {
            background-color: #337ab7;
            color: white;
            text-align: center;
        }
        .sensor-table td {
            text-align: center;
            vertical-align: middle;
        }
        .sensor-value {
            font-weight: bold;
            font-size: 16px;
        }
        .chart-controls {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .chart-container {
            margin-top: 20px;
            min-height: 400px;
        }
        .pagination-controls {
            margin: 15px 0;
            text-align: center;
        }
        .btn-group {
            margin: 5px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .sensor-table {
                font-size: 12px;
            }
            .chart-controls {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Monitor de Sensores en Tiempo Real</h1>
        
        <!-- Tabla de sensores -->
        <div class="sensor-table">
            <h3>Estado Actual de Sensores</h3>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Sensor</th>
                        <th>칔ltimo Valor</th>
                        <th>Fecha/Hora</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="sensorsTableBody">
                    <!-- Se llena din치micamente -->
                </tbody>
            </table>
        </div>

        <!-- Controles de gr치fica -->
        <div class="chart-controls">
            <h3>An치lisis Hist칩rico</h3>
            <div class="row">
                <div class="col-md-4">
                    <label for="sensorSelect">Seleccionar Sensor:</label>
                    <select id="sensorSelect" class="form-control">
                        <option value="">Seleccione un sensor...</option>
                        <option value="sensor1">Sensor 1</option>
                        <option value="sensor2">Sensor 2</option>
                        <option value="sensor3">Sensor 3</option>
                        <option value="sensor4">Sensor 4</option>
                        <option value="sensor5">Sensor 5</option>
                        <option value="sensor6">Sensor 6</option>
                        <option value="sensor7">Sensor 7</option>
                        <option value="sensor8">Sensor 8</option>
                        <option value="sensor9">Sensor 9</option>
                        <option value="sensor10">Sensor 10</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary form-control" onclick="cargarDatosSensor()">
                        游늵 Cargar Datos del Sensor
                    </button>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button class="btn btn-success form-control" onclick="cargarTodosLosSensores()">
                        游늳 Vista General (Todos)
                    </button>
                </div>
            </div>
        </div>

        <!-- Controles de paginaci칩n -->
        <div class="pagination-controls" id="paginacionControles" style="display: none;">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="paginarPor('dias')">游늰 Por D칤as</button>
                <button class="btn btn-sm btn-outline-primary" onclick="paginarPor('semanas')">游늵 Por Semanas</button>
                <button class="btn btn-sm btn-outline-primary" onclick="paginarPor('meses')">游늳 Por Meses</button>
                <button class="btn btn-sm btn-outline-primary" onclick="paginarPor('a침os')">游늴 Por A침os</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn btn-sm btn-secondary" onclick="anteriorPagina()">&lt;</button>
                <span id="paginaInfo" style="margin: 0 10px;">P치gina 1 de 1</span>
                <button class="btn btn-sm btn-secondary" onclick="siguientePagina()">&gt;</button>
            </div>
        </div>

        <!-- Contenedor de gr치fica -->
        <div class="chart-container">
            <div id="myPlot" style="width: 100%; height: 500px;"></div>
        </div>
    </div>

    <script>
        // Variables globales
        const SERVER_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3003' 
            : 'https://tu-backend-url.com'; // Cambiar por tu URL de hosting
        let datosConsultados = [];
        let paginaActual = 0;
        let tipoPaginacion = 'dias';
        let datosPaginados = [];
        let sensorSeleccionado = '';

        // Funci칩n para actualizar tabla de sensores
        async function actualizarTablaSensores() {
            try {
                const response = await fetch(`${SERVER_URL}/api/sensores-info`);
                const info = await response.json();
                
                if (!info.lastRecord) {
                    $('#sensorsTableBody').html('<tr><td colspan="4">No hay datos disponibles</td></tr>');
                    return;
                }

                const lastRecord = info.lastRecord;
                const tbody = $('#sensorsTableBody');
                tbody.empty();

                // Crear filas para cada sensor (sensor1 a sensor10)
                for (let i = 1; i <= 10; i++) {
                    const sensorKey = `sensor${i}`;
                    const valor = lastRecord.sensores && lastRecord.sensores[sensorKey] ? lastRecord.sensores[sensorKey].valor : undefined;
                    const fecha = lastRecord.fechaHora ? new Date(lastRecord.fechaHora).toLocaleString('es-ES') : 'N/A';
                    const estado = valor !== undefined ? 'Activo' : 'Sin datos';
                    const valorMostrar = valor !== undefined ? `${valor} mm` : 'N/A';

                    const row = `
                        <tr>
                            <td><strong>Sensor ${i}</strong></td>
                            <td class="sensor-value">${valorMostrar}</td>
                            <td>${fecha}</td>
                            <td>
                                <span class="label ${estado === 'Activo' ? 'label-success' : 'label-default'}">
                                    ${estado}
                                </span>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                }

                console.log('Tabla de sensores actualizada');
            } catch (error) {
                console.error('Error actualizando tabla:', error);
                $('#sensorsTableBody').html('<tr><td colspan="4"><i class="glyphicon glyphicon-refresh"></i> Obteniendo datos...</td></tr>');
            }
        }

        // Funci칩n para cargar datos de un sensor espec칤fico
        async function cargarDatosSensor() {
            const sensor = $('#sensorSelect').val();
            if (!sensor) {
                alert('Por favor selecciona un sensor');
                return;
            }

            sensorSeleccionado = sensor;
            $('#myPlot').html('<div style="text-align:center;padding:50px;">Cargando datos del ' + sensor + '...</div>');

            try {
                const allData = await loadAllSensorData();
                const sensorData = allData
                    .filter(record => record.sensores && record.sensores[sensor] && record.sensores[sensor].valor !== undefined)
                    .map(record => ({
                        x: record.fechaHora,
                        y: record.sensores[sensor].valor
                    }));

                if (sensorData.length === 0) {
                    $('#myPlot').html('<div style="text-align:center;padding:50px;">No hay datos para este sensor</div>');
                    return;
                }

                datosConsultados = sensorData;
                paginarPor('dias');
                $('#paginacionControles').show();
                
            } catch (error) {
                console.error('Error cargando datos del sensor:', error);
                $('#myPlot').html('<div style="text-align:center;padding:50px;color:#337ab7;"><i class="glyphicon glyphicon-refresh"></i> Obteniendo datos...</div>');
            }
        }

        // Funci칩n para cargar todos los sensores
        async function cargarTodosLosSensores() {
            $('#myPlot').html('<div style="text-align:center;padding:50px;">Cargando datos de todos los sensores...</div>');
            
            try {
                const allData = await loadAllSensorData();
                
                const traces = [];
                const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
                
                for (let i = 1; i <= 10; i++) {
                    const sensorKey = `sensor${i}`;
                    const sensorData = allData
                        .filter(record => record[sensorKey] !== undefined)
                        .map(record => ({
                            x: record.fechaa,
                            y: record[sensorKey]
                        }));
                    
                    if (sensorData.length > 0) {
                        traces.push({
                            x: sensorData.map(d => d.x),
                            y: sensorData.map(d => d.y),
                            type: 'scatter',
                            mode: 'lines',
                            name: `Sensor ${i}`,
                            line: { color: colors[i-1] }
                        });
                    }
                }
                
                if (traces.length === 0) {
                    $('#myPlot').html('<div style="text-align:center;padding:50px;">No hay datos disponibles</div>');
                    return;
                }
                
                const layout = {
                    title: 'Vista General - Todos los Sensores',
                    xaxis: { title: 'Fecha/Hora' },
                    yaxis: { title: 'Valor (mm)' },
                    showlegend: true,
                    responsive: true
                };
                
                const config = {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                };
                
                Plotly.newPlot('myPlot', traces, layout, config);
                $('#paginacionControles').hide();
                
            } catch (error) {
                console.error('Error cargando todos los sensores:', error);
                $('#myPlot').html('<div style="text-align:center;padding:50px;color:#337ab7;"><i class="glyphicon glyphicon-refresh"></i> Obteniendo datos...</div>');
            }
        }

        // Funci칩n para cargar todos los datos del sensor
        async function loadAllSensorData() {
            try {
                const response = await fetch(`${SERVER_URL}/api/sensores-data?limit=10000`);
                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                return await response.json();
            } catch (error) {
                console.error('Error cargando datos:', error);
                throw error;
            }
        }

        // Funciones de paginaci칩n
        function paginarPor(tipo) {
            tipoPaginacion = tipo;
            paginaActual = 0;
            
            const ahora = new Date();
            let intervalos = [];
            
            switch(tipo) {
                case 'dias':
                    for (let i = 0; i < 30; i++) {
                        const fecha = new Date(ahora);
                        fecha.setDate(fecha.getDate() - i);
                        intervalos.push({
                            inicio: new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate()),
                            fin: new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate() + 1),
                            nombre: fecha.toLocaleDateString('es-ES')
                        });
                    }
                    break;
                case 'semanas':
                    for (let i = 0; i < 12; i++) {
                        const fecha = new Date(ahora);
                        fecha.setDate(fecha.getDate() - (i * 7));
                        const inicioSemana = new Date(fecha);
                        inicioSemana.setDate(fecha.getDate() - fecha.getDay());
                        const finSemana = new Date(inicioSemana);
                        finSemana.setDate(inicioSemana.getDate() + 7);
                        intervalos.push({
                            inicio: inicioSemana,
                            fin: finSemana,
                            nombre: `Semana del ${inicioSemana.toLocaleDateString('es-ES')}`
                        });
                    }
                    break;
                case 'meses':
                    for (let i = 0; i < 12; i++) {
                        const fecha = new Date(ahora.getFullYear(), ahora.getMonth() - i, 1);
                        const finMes = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 1);
                        intervalos.push({
                            inicio: fecha,
                            fin: finMes,
                            nombre: fecha.toLocaleDateString('es-ES', { year: 'numeric', month: 'long' })
                        });
                    }
                    break;
                case 'a침os':
                    for (let i = 0; i < 5; i++) {
                        const a침o = ahora.getFullYear() - i;
                        intervalos.push({
                            inicio: new Date(a침o, 0, 1),
                            fin: new Date(a침o + 1, 0, 1),
                            nombre: a침o.toString()
                        });
                    }
                    break;
            }
            
            datosPaginados = intervalos;
            mostrarPagina();
        }

        function mostrarPagina() {
            if (datosPaginados.length === 0) return;
            
            const intervalo = datosPaginados[paginaActual];
            const datosFiltrados = datosConsultados.filter(d => {
                const fecha = new Date(d.x);
                return fecha >= intervalo.inicio && fecha < intervalo.fin;
            });
            
            if (datosFiltrados.length === 0) {
                $('#myPlot').html(`<div style="text-align:center;padding:50px;">No hay datos para ${intervalo.nombre}</div>`);
            } else {
                const trace = {
                    x: datosFiltrados.map(d => d.x),
                    y: datosFiltrados.map(d => d.y),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: sensorSeleccionado.toUpperCase(),
                    line: { color: '#337ab7' }
                };
                
                const layout = {
                    title: `${sensorSeleccionado.toUpperCase()} - ${intervalo.nombre}`,
                    xaxis: { title: 'Fecha/Hora' },
                    yaxis: { title: 'Valor (mm)' },
                    responsive: true
                };
                
                const config = {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                };
                
                Plotly.newPlot('myPlot', [trace], layout, config);
            }
            
            $('#paginaInfo').text(`P치gina ${paginaActual + 1} de ${datosPaginados.length}`);
        }

        function anteriorPagina() {
            if (paginaActual > 0) {
                paginaActual--;
                mostrarPagina();
            }
        }

        function siguientePagina() {
            if (paginaActual < datosPaginados.length - 1) {
                paginaActual++;
                mostrarPagina();
            }
        }

        // Inicializaci칩n
        $(document).ready(function() {
            // Actualizar tabla inmediatamente
            actualizarTablaSensores();
            
            // Actualizar tabla cada 5 segundos
            setInterval(actualizarTablaSensores, 5000);
            
            // Mensaje inicial en la gr치fica
            $('#myPlot').html('<div style="text-align:center;padding:50px;color:#666;">Selecciona un sensor para ver sus datos hist칩ricos</div>');
        });
    </script>
</body>
</html>             
                const traces = [{
                    x: sensorData.map(d => d.x),
                    y: sensorData.map(d => d.y),
                    type: 'scattergl',
                    mode: 'lines+markers',
                    marker: { size: 2 },
                    name: sensor.toUpperCase(),
                    hovertemplate: '%{x|%d/%m/%Y, %I:%M:%S %p}<br>%{y} mm<extra></extra>'
                }];

                Plotly.purge('myPlot');
                Plotly.newPlot('myPlot', traces, {
                    title: `Historial del ${sensor.toUpperCase()} (${sensorData.length} registros)`,
                    xaxis: { title: 'Fecha' },
                    yaxis: { 
                        title: 'Nivel de Agua (mm)',
                        ticksuffix: ' mm'
                    },
                    autosize: true,
                    margin: { l: 60, r: 20, t: 50, b: 50 }
                }, { responsive: true, displayModeBar: true });

                $('#paginacionControles').show();

            } catch (error) {
                console.error('Error cargando sensor:', error);
                $('#myPlot').html('<div style="text-align:center;padding:50px;color:red;">Error cargando datos</div>');
            }
        }

        // Funci칩n para cargar vista general de todos los sensores
        async function cargarTodosLosSensores() {
            $('#myPlot').html('<div style="text-align:center;padding:50px;">Cargando vista general...</div>');

            try {
                const allData = await loadAllSensorData();
                const traces = [];

                // Crear una traza por cada sensor que tenga datos
                for (let i = 1; i <= 10; i++) {
                    const sensorKey = `sensor${i}`;
                    const sensorData = allData
                        .filter(record => record[sensorKey] !== undefined)
                        .map(record => ({
                            x: record.fechaa,
                            y: record[sensorKey]
                        }));

                    if (sensorData.length > 0) {
                        // Usar solo cada 10mo punto para vista general
                        const sampledData = sensorData.filter((_, index) => index % 10 === 0);
                        
                        traces.push({
                            x: sampledData.map(d => d.x),
                            y: sampledData.map(d => d.y),
                            type: 'scattergl',
                            mode: 'lines',
                            name: `Sensor ${i}`,
                            hovertemplate: '%{x|%d/%m/%Y}<br>%{y} mm<extra></extra>'
                        });
                    }
                }

                if (traces.length === 0) {
                    $('#myPlot').html('<div style="text-align:center;padding:50px;">No hay datos disponibles</div>');
                    return;
                }

                Plotly.purge('myPlot');
                Plotly.newPlot('myPlot', traces, {
                    title: `Vista General - Todos los Sensores (${traces.length} sensores activos)`,
                    xaxis: { title: 'Fecha' },
                    yaxis: { 
                        title: 'Nivel de Agua (mm)',
                        ticksuffix: ' mm'
                    },
                    autosize: true,
                    margin: { l: 60, r: 20, t: 50, b: 50 }
                }, { responsive: true, displayModeBar: true });

                $('#paginacionControles').hide();

            } catch (error) {
                console.error('Error cargando vista general:', error);
                $('#myPlot').html('<div style="text-align:center;padding:50px;color:red;">Error cargando datos</div>');
            }
        }

        // Funci칩n para cargar todos los datos
        async function loadAllSensorData() {
            const allData = [];
            const limit = 1000;
            let offset = 0;

            while (true) {
                try {
                    const response = await fetch(`${SERVER_URL}/api/sensores-data?limit=${limit}&offset=${offset}`);
                    if (!response.ok) break;

                    const chunk = await response.json();
                    if (chunk.length === 0) break;

                    allData.push(...chunk);
                    offset += chunk.length;

                    if (chunk.length < limit) break;

                } catch (error) {
                    console.error('Error:', error);
                    break;
                }
            }

            return allData;
        }

        // Funciones de paginaci칩n (simplificadas)
        function paginarPor(periodo) {
            if (!datosConsultados || datosConsultados.length === 0) {
                alert('Primero carga los datos de un sensor');
                return;
            }

            tipoPaginacion = periodo;
            paginaActual = 0;

            const datos = new Map();
            
            datosConsultados.forEach(record => {
                const fecha = new Date(record.x);
                let clave;
                
                switch(periodo) {
                    case 'dias':
                        clave = fecha.toISOString().split('T')[0];
                        break;
                    case 'semanas':
                        const semana = new Date(fecha);
                        semana.setDate(fecha.getDate() - fecha.getDay());
                        clave = semana.toISOString().split('T')[0];
                        break;
                    case 'meses':
                        clave = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                        break;
                    case 'a침os':
                        clave = fecha.getFullYear().toString();
                        break;
                }
                
                if (!datos.has(clave)) datos.set(clave, []);
                datos.get(clave).push(record);
            });
            
            datosPaginados = Array.from(datos.keys()).sort().map(clave => datos.get(clave));
            mostrarPagina();
        }

        function mostrarPagina() {
            if (!datosPaginados || datosPaginados.length === 0) return;
            
            const datosActuales = datosPaginados[paginaActual] || [];
            
            Plotly.purge('myPlot');
            
            Plotly.newPlot('myPlot', [{
                x: datosActuales.map(d => d.x),
                y: datosActuales.map(d => d.y),
                type: 'scattergl',
                mode: 'lines+markers',
                marker: { size: 2 },
                name: sensorSeleccionado.toUpperCase(),
                hovertemplate: '%{x|%d/%m/%Y, %I:%M:%S %p}<br>%{y} mm<extra></extra>'
            }], {
                title: `${sensorSeleccionado.toUpperCase()} - ${tipoPaginacion.charAt(0).toUpperCase() + tipoPaginacion.slice(1)} - P치gina ${paginaActual + 1}`,
                xaxis: { title: 'Fecha' },
                yaxis: { 
                    title: 'Nivel de Agua (mm)',
                    ticksuffix: ' mm'
                },
                autosize: true,
                margin: { l: 60, r: 20, t: 50, b: 50 }
            }, { responsive: true, displayModeBar: true });
            
            $('#paginaInfo').text(`P치gina ${paginaActual + 1} de ${datosPaginados.length}`);
            
            $('button[onclick="anteriorPagina()"]').prop('disabled', paginaActual === 0);
            $('button[onclick="siguientePagina()"]').prop('disabled', paginaActual >= datosPaginados.length - 1);
        }

        function anteriorPagina() {
            if (datosPaginados && paginaActual > 0) {
                paginaActual--;
                mostrarPagina();
            }
        }

        function siguientePagina() {
            if (datosPaginados && paginaActual < datosPaginados.length - 1) {
                paginaActual++;
                mostrarPagina();
            }
        }

        // Inicializaci칩n
        $(document).ready(function() {
            $('#myPlot').html('<div style="text-align:center;padding:50px;color:#666;">Selecciona un sensor para ver su gr치fica</div>');
            
            // Actualizar tabla cada 10 segundos
            actualizarTablaSensores();
            setInterval(actualizarTablaSensores, 10000);
            
            console.log('Monitor de sensores iniciado');
        });
    </script>
</body>
</html>